<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>编辑订单</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../static/css/font.css">
    <link rel="stylesheet" href="../../static/css/weadmin.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="../../lib/layui/layui.js" charset="utf-8"></script>
</head>

<body>
<div class="weadmin-body">
    <form class="layui-form">
        <input type="hidden" name="orderId" id="orderId">
        
        <div class="layui-form-item">
            <label class="layui-form-label">收货人</label>
            <div class="layui-input-inline">
                <input type="text" name="recipientName" required lay-verify="required"
                       placeholder="请输入收货人" autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">总金额</label>
            <div class="layui-input-inline">
                <input type="text" name="totalAmount" required lay-verify="required"
                       placeholder="请输入总金额" autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">应付金额</label>
            <div class="layui-input-inline">
                <input type="text" name="payableAmount" required lay-verify="required"
                       placeholder="请输入应付金额" autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">订单状态</label>
            <div class="layui-input-inline">
                <select name="orderStatus" lay-verify="required">
                    <option value="">请选择订单状态</option>
                    <option value="待支付">待支付</option>
                    <option value="已支付">已支付</option>
                    <option value="已取消">已取消</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">支付状态</label>
            <div class="layui-input-inline">
                <select name="paymentStatus" lay-verify="required">
                    <option value="">请选择支付状态</option>
                    <option value="未支付">未支付</option>
                    <option value="已支付">已支付</option>
                    <option value="支付失败">支付失败</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">发货状态</label>
            <div class="layui-input-inline">
                <select name="shippingStatus" lay-verify="required">
                    <option value="">请选择发货状态</option>
                    <option value="未发货">未发货</option>
                    <option value="已发货">已发货</option>
                    <option value="已签收">已签收</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">支付方式</label>
            <div class="layui-input-inline">
                <select name="paymentMethod" lay-verify="required">
                    <option value="">请选择支付方式</option>
                    <option value="微信">微信</option>
                    <option value="支付宝">支付宝</option>
                    <option value="银行卡">银行卡</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">配送方式</label>
            <div class="layui-input-inline">
                <select name="deliveryMethod" lay-verify="required">
                    <option value="">请选择配送方式</option>
                    <option value="顺丰">顺丰</option>
                    <option value="圆通">圆通</option>
                    <option value="中通">中通</option>
                    <option value="韵达">韵达</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="formSubmit">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>

<script>
    layui.use(['form', 'layer'], function(){
        var form = layui.form;
        var layer = layui.layer;
        
        // 获取URL中的订单ID
        var urlParams = new URLSearchParams(window.location.search);
        var orderId = urlParams.get('id');
        
        // 如果有订单ID，则加载订单数据
        if (orderId) {
            axios({
                method: 'get',
                url: 'http://localhost:8080/orders/getById/' + orderId
            })
            .then(response => {
                if (response.data.code === 200) {
                    var order = response.data.data;
                    // 设置表单值
                    document.querySelector('[name="orderId"]').value = order.orderId;
                    document.querySelector('[name="recipientName"]').value = order.recipientName;
                    document.querySelector('[name="totalAmount"]').value = order.totalAmount;
                    document.querySelector('[name="payableAmount"]').value = order.payableAmount;
                    document.querySelector('[name="orderStatus"]').value = order.orderStatus;
                    document.querySelector('[name="paymentStatus"]').value = order.paymentStatus;
                    document.querySelector('[name="shippingStatus"]').value = order.shippingStatus;
                    document.querySelector('[name="paymentMethod"]').value = order.paymentMethod;
                    document.querySelector('[name="deliveryMethod"]').value = order.deliveryMethod;
                    
                    // 更新表单渲染
                    form.render();
                } else {
                    layer.msg('获取订单数据失败: ' + response.data.msg, {icon: 2});
                }
            })
            .catch(error => {
                console.error('获取订单数据失败:', error);
                layer.msg('获取订单数据失败，请稍后重试', {icon: 2});
            });
        }

        // 监听提交
        form.on('submit(formSubmit)', function(data){
            axios({
                method: 'post',
                url: 'http://localhost:8080/orders/update',
                headers: {
                    'Content-Type': 'application/json'
                },
                data: data.field
            })
            .then(response => {
                if (response.data.code === 200) {
                    layer.msg('更新成功', {icon: 1});
                    // 关闭当前页面并刷新父页面
                    setTimeout(function(){
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                        parent.location.reload();
                    }, 1000);
                } else {
                    layer.msg('更新失败: ' + response.data.msg, {icon: 2});
                }
            })
            .catch(error => {
                console.error('更新订单失败:', error);
                layer.msg('更新失败，请稍后重试', {icon: 2});
            });

            return false; // 阻止表单跳转
        });
    });
</script>
</body>
</html>